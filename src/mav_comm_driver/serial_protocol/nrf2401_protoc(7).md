
# 协议
上位机：电脑端控制软件；  
下位机：机载飞控；  
下行的协议分为五个模式：开始模式（等待模式），手动控制模式，实际应用模式，调参实验模式，故障模式;  
五种不同的模式，所下发的指令不一样；具体根据飞行器收到的报文ID作判断；  
## 故障模式(0x00)：
(1) 开机后的初始化模式；  
(2) 完成当前NRF24L01的状态检测，如果检测NRF24L01离线或者通讯失败,则一直处于这个模式中，直到通讯成功，跳转到开始模式；
## 开始模式(0x08)：  
完成所有执行器和状态量的初始化，检测通讯是否正常，更新状态位；
## 手动控制模式(0x10)：  
上位机能直接控制各电机，各舵机，此时遥控的指令失效；机载下位机实时发送姿态状态值、电机控制量值、PID参数值；  
## 实际应用模式(0x18)：  
此状态下，上位机不再直接控制各执行器，而是控制飞行器的飞行运动（前后、升降、左右、偏航）和PID的参数值；下位机自身在PID算法的作用下保持稳定; 下位机实时上传姿态信息，电机驱动电机；
## 调参实验模式(0x38):  
此状态下，要能实现在线PID调参；上位机发送当前所设定的姿态角度信息，设定的PID的参数信息，下位机实时回传当前实际的姿态角度，PID误差信息，电机舵机控制信息；  

系统状态结构变量SYS_Status，其中DTU_NRF_Status 表示当前遥控接收机，NRF无线传输模块是否存在，并且通讯是否正常；
DTU_NRF_Status 是一个u8变量，其中每一位代表的含义：
| 位数 | 7 | 6 | 5 |4| 3 | 2 | 1 | 0 |
|---|---|---|---|---|---|---|---|---|
||暂留|flash_write_flag|MODE_ID3|MODE_ID2|MODE_ID1| DTU是否能正常通讯 | NRF是否通讯正常 | NRF是否在线 |


## 上行  
### 开始模式（START_MODE）：
| 字节数 |23|22|21|20|19|18|17|16|
|---|---|---|---|---|---|---|---|---|
|||爬行机构|拍打机构|中舵机|左舵机|右舵机|SYS_Status|系统时间_H2| 
| 字节数 |15|14|13|12|11|10|9|8|
||系统时间_H1|系统时间_L2|系统时间_L1|当前横滚角速度_H|当前横滚角速度_L|当前俯仰角速度_H|当前俯仰角速度_L|当前偏航角速度_H|
| 字节数 |7|6|5|4|3|2|1|0|
||当前偏航角速度_L|当前横滚角_H|当前横滚角_L|当前俯仰角_H|当前俯仰角_L|当前偏航角_H|当前偏航角_L|0x08|
||||||||||

### 手动控制模式（MANUAL_MODE）： 
| 字节数 |23|22|21|20|19|18|17|16|
|---|---|---|---|---|---|---|---|---|
|||爬行机构|拍打机构|中舵机|左舵机|右舵机|SYS_Status|系统时间_H2| 
| 字节数 |15|14|13|12|11|10|9|8|
||系统时间_H1|系统时间_L2|系统时间_L1|当前翻滚角速度_H|当前翻滚角速度_L|当前俯仰角速度_H|当前俯仰角速度_L|当前偏航角速度_H|
| 字节数 |7|6|5|4|3|2|1|0|
||当前偏航角速度_L|当前横滚角_H|当前横滚角_L|当前俯仰角_H|当前俯仰角_L|当前偏航角_H|当前偏航角_L|0x10|
|||||||||| 

### 实际应用模式（FLIGHT_MODE）：
| 字节数 |31|30|29|28|27|26|25|24|
|---|---|---|---|---|---|---|---|---|
||||ROLL_Kd_Int_out_H|ROLL_Kd_Int_out_L|ROLL_Kp_Int_out_H|ROLL_Kp_Int_out_L|PITCH_Kd_Int_out_H|PITCH_Kd_Int_out_L|
| 字节数 |23|22|21|20|19|18|17|16|
||PITCH_Kp_Int_out_H|PITCH_Kp_Int_out_L|拍打机构|中舵机|左舵机|右舵机|SYS_Status|系统时间_H2| 
| 字节数 |15|14|13|12|11|10|9|8|
||系统时间_H1|系统时间_L2|系统时间_L1|当前翻滚角速度_H|当前翻滚角速度_L|当前俯仰角速度_H|当前俯仰角速度_L|当前偏航角速度_H|
| 字节数 |7|6|5|4|3|2|1|0|
||当前偏航角速度_L|当前横滚角_H|当前横滚角_L|当前俯仰角_H|当前俯仰角_L|当前偏航角_H|当前偏航角_L|0x18|
|||||||||| 
### 调参实验模式（TUNING_MODE）：
| 字节数 |31|30|29|28|27|26|25|24|
|---|---|---|---|---|---|---|---|---|
|||拍打机构|中舵机|左舵机|右舵机|PID_ID|(PID_ID)_Kd_Int_out_H|(PID_ID)_Kd_Int_out_L|
| 字节数 |23|22|21|20|19|18|17|16|
||(PID_ID)_Ki_Int_out_H|(PID_ID)_Ki_Int_out_L|(PID_ID)_Kp_Int_out_H|(PID_ID)_Kp_Int_out_L|(PID_ID)_Kd_Ext_out_H|(PID_ID)_Kd_Ext_out_L|(PID_ID)_Ki_Ext_out_H|(PID_ID)_Ki_Ext_out_L| 
| 字节数 |15|14|13|12|11|10|9|8|
||(PID_ID)_Kp_Ext_out_H|(PID_ID)_Kp_Ext_out_L|Setpoint_Int_H|Setpoint_Int_L|Error_Ext_H|Error_Ext_L|SYS_Status|系统时间_H2|
| 字节数 |7|6|5|4|3|2|1|0|
||系统时间_H1|系统时间_L2|系统时间_L1|(PID_ID)_rate_H|(PID_ID)_rate_L|(PID_ID)_angle_H|(PID_ID)_angle_L|0x38|
|||||||||| 
#### 上行数据放大说明：
角度上传值 = 角度真实值 * 100；  
角速度上传值 = 角速度真实值；  
角度误差上传值 = 角度误差真实值 * 100；  
角速度误差上传值  = 角速度误差真实值 * 10；  
PID计算值的上传值 = PID计算值的真实值 * 10；


### 故障模式（FAULT_MODE）：
| 字节数 |23|22|21|20|19|18|17|16|  
|---|---|---|---|---|---|---|---|---|
|||||中舵机|左舵机|右舵机|SYS_Status|系统时间_H2| 
| 字节数 |15|14|13|12|11|10|9|8|
||系统时间_H1|系统时间_L2|系统时间_L1|当前翻滚角速度_H|当前翻滚角速度_L|当前俯仰角速度_H|当前俯仰角速度_L|当前偏航角速度_H|
| 字节数 |7|6|5|4|3|2|1|0|
||当前偏航角速度_L|当前横滚角_H|当前横滚角_L|当前俯仰角_H|当前俯仰角_L|当前偏航角_H|当前偏航角_L|0x00 |
|||||||||| 

## 下行
### 开始模式（START_MODE）：  
报文ID: 0x08 
| 字节数 | 4 | 3 | 2 | 1 | 0 |
|---|---|---|---|---|---| 
|  |拍打电机|中舵机|左舵机|右舵机|0x08|

开始模式下下发的数据为初始时各舵机的位置；  
  
### 手动控制模式（MANUAL_MODE）：

报文ID: 0x10

|字节数| 7 | 6 | 5 |4| 3 | 2 | 1 | 0 |
|---|---|---|---|---|---|---|---|---|
||||爬行电机|拍打电机|中舵机|左舵机|右舵机|0x10|
||||||||||


### 实际应用模式（FLIGHT_MODE）：
报文ID: 0x18

|字节数| 7 | 6 | 5 |4| 3 | 2 | 1 | 0 |
|---|---|---|---|---|---|---|---|---|
||||油门|偏航|升降|左右|前后|0x18|
||||||||||

### 调参实验模式（TUNING_MODE）
报文ID: 0x38


| 字节数 |31|30|29|28|27|26|25|24|
|---|---|---|---|---|---|---|---|---|
||||||||||
| 字节数 |23|22|21|20|19|18|17|16|
||拍打电机|(PID_ID)_SetValue_H|(PID_ID)_SetValue_L|(PID_ID)_Limit_Int|(PID_ID)_Limitlow_Int|(PID_ID)_Limit_Ext_H|(PID_ID)_Limit_Ext_L|(PID_ID)_Limitlow_Ext_H|
|字节数| 15|14|13|12| 11 | 10 | 9 | 8 |
||(PID_ID)_Limitlow_Ext_L|PID_ID|refresh frequency|(PID_ID)_Kd_Ext_H|(PID_ID)_Kd_Ext_L|(PID_ID)_Ki_Ext_H|(PID_ID)_Ki_Ext_L|(PID_ID)_Kp_Ext_H|
|字节数| 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
||(PID_ID)_Kp_Ext_L|(PID_ID)_Kd_Int_H|(PID_ID)_Kd_Int_L|(PID_ID)_Ki_Int_H|(PID_ID)_Ki_Int_L|(PID_ID)_Kp_Int_H|(PID_ID)_Kp_Int_L|0x38|
||||||||||

### 故障模式（TUNING_MODE）
报文ID: 0x00
|字节数| 7 | 6 | 5 |4| 3 | 2 | 1 | 0 |
|---|---|---|---|---|---|---|---|---|
|||||||||0x00|
||||||||||


调参实验也分成两种模式：  
一：单轴模式；  
YAW , PITCH, ROLL分别单独调整；  
二： 整机模式；  
YAW , PITCH, ROLL的PID同时上，模拟真实的场景；当PID_ID为ALL(0x04)时，表示整机模式；

 





